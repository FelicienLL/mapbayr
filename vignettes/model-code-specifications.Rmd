---
title: "Model Code Specifications"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{"Model Code Specifications"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

mapbayr contains a library of example model files (.cpp), accessible with `mbrlib()`
```{r, eval = F}
my_model <- mread("ex_mbr1.cpp", mbrlib())
```

The user is invited to perform MAP-Bayesian estimations with his/her own mrgsolve models. See how to code a basic mrgsolve model in the [introduction to mrgsolve vignette](introduction-to-mrgsolve.html). These must be slightly modified in order to be used by mapbayr.

## In brief

From an already existing mrgsolve model:

- In `$PARAM`: add `ETA1`, `ETA2` (etc...) parameters, with a default value of 0.
- In `$MAIN`: duplicate random effects such as : `CL = TVCL * exp(ETA(1) + ETA1)` etc...
- In `OMEGA`: define values of the variances of the parameters of interest.
- In `$SIGMA`: define two values of variances, the first proportional error, the second for additive one.

## Full specifications
### 1.  `$PARAM` block
#### 1.1 ETA specifications
* Mandatory: 
  + Add as many ETA as there are parameters to estimate (i.e. the length of the OMEGA matrix diagonal). 
  + Name them as ETAn (n being the N° of ETA).
  + Set 0 as default value. 
* Strongly recommended:   
  + Provide a description as a plain text
```{c, eval = F}
$PARAM @annotated
ETA1 : 0 : CL (L/h)
ETA2 : 0 : VC (L)
ETA3 : 0 : F ()
//do not write ETA(1)
//do not write iETA

```

#### 1.2 Covariates
* Mandatory: 
  + Use a `@covariates` tag to record covariates in the `$PARAM` block. Otherwise, you will not be allowed to pass a dataset with covariates columns.
  + Set the reference value.
* Strongly recommended  
  + Provide a description as a plain text
  + Provide units in parentheses (or a description of 0/1 coding for categorical covariates)

```{c, eval = F}
$PARAM @annotated @covariates
BW : 70 : Body weight (kg)
SEX : 0 : Sex (0=Male, 1=Female)
```

### 2.  `$CMT` block
* Strongly recommended...  
... yet **mandatory** if you use `obs_lines()` and `adm_lines()` to build your dataset, or if you have multiple types of DV, i.e. parent drug + metabolite: 
  + A `@annotated` tag must be used to record compartments.
  + Write OBS in brackets to define the observation compartment(s). Also used by `obs_lines()` to build your dataset. 
  + Write ADM in brackets to define "default" administration compartment(s). This information is not used for optimization process and the `mapbayest()` function. The information is mandatory if you use `adm_lines()` to build your dataset in order to automatically set the value of the 'cmt' column. Especially useful if you use a model with an absorption from several depot compartment requiring to duplicate administrations lines in the data set. 

```{c, eval = F}
//example: model with dual zero and first order absorption in compartment 1 & 2, respectively, and observation of parent drug + metabolite 
$CMT @annotated
DEPOT: Depot [ADM]
CENT_PAR: examplinib central [ADM, OBS]
PERIPH : examplinib peripheral
CENT_MET : methylexamplinib central [OBS] 
```

### 3.  `$OMEGA` block
* Mandatory: 
  + The length of the omega matrix must be the same as the number of ETAn provided in `$PARAM`.
  + The order of the omega values must correspond to the order of the ETAs provided in `$PARAM`. This cannot be checked by mapbayr !

```{c, eval = F}
$OMEGA
0.123 0.456 0.789
$OMEGA @block
0.111 
0.222 0.333
// reminder: omega values can be recorded in multiple $OMEGA blocks
```

### 4.  `$SIGMA` block
The definition of the `$SIGMA` block may not be as straightforward as other blocks, but we tried to keep it as simple as possible. Keep in mind that mapbayr always expect a **pair of sigma values** for each type of dependent variable: the **first** value for proportional error, the **second** for additive.  

Two situations can be distinguished:  

1. You only have one type of concentration to fit, and you did not use the [OBS] assignment in `$CMT`.  

Simply write **one pair** of sigma values to describe proportional and additive error on your concentrations. This error model will be automatically applied to the compartment where observations were recorded in your dataset (i.e. value of CMT when MDV = 0).  

```{c, eval = F}
$SIGMA 0.111 0 // proportional error 
```
```{c, eval = F}
$SIGMA 0 0.222 // (log) additive error
```
```{c, eval = F}
$SIGMA 0.333 0.444 // mixed error
```

2. You have multiple DV to fit (parent and metabolite), and/or you used the [OBS] assignment in `$CMT`.  

Write as many **pairs of sigma values** as there are compartments assigned with [OBS] in `$CMT`. The order of the pair must respect the order in which compartments were assigned. To put it more clearly, the sigma matrix will be interpreted as such whatever the model : 

| N° in the SIGMA matrix diagonal | Associated error |
|:-------------------------------:|:----------------:|
| 1 | Proportional on concentrations in the 1st cmt with [OBS] |
| 2 | Additive on concentrations in the 1st cmt with [OBS] |
| 3 | Proportional on concentrations in the 2nd cmt with [OBS] |
| 4 | Additive on concentrations in the 2nd cmt with [OBS] |

```{c, eval = F}
//example: correlated proportional error between parent and metabolite
$SIGMA @block
0.050 // proportional error on parent drug
0.000 0.000 // additive error on parent drug
0.100 0.000 0.200 // proportional error on metabolite
0.000 0.000 0.000 0.000 // additive error on metabolite
// reminder: sigma values can be recorded in multiple $SIGMA blocks
```

### 6.  `$TABLE` block or `$ERROR` block


* Mandatory: 
  + Refer the concentration variable to fit as `DV`. Mind the code, especially if concentrations are observed in multiple compartments. 
  + Express log-additive error models as exponential. This way, concentrations will automatically log-transformed during the optimization process, with no necessity to prior log-transform your concentration. 
```{c, eval = F}
$TABLE
double DV  = (CENTRAL / VC) * exp(EPS(2)) ;
```
  + For fitting parent drug and metabolite simultaneously, refer to them as PAR and MET, and define DV accordingly (only DV will be used during the optimization process, but PAR and MET variables are mandatory for post-processing internal functions)

```{c, eval = F}
$TABLE
double PAR = (CENT_PAR / V) * (1 + EPS(1)) ;
double MET = (CENT_MET / V) * (1 + EPS(3)) ;
double DV = PAR ;
if(self.cmt == 4) DV = MET ; 
// reminder: use "self.cmt" to internaly refer to a compartment in a mrgsolve model code. 
```


Note that mapbayr does not strictly rely on this `$ERROR` block to define the residual error internally and compute the objective function value, but on information passed in the `$SIGMA` block. However, we strongly advise you to properly code your `$ERROR` block with `EPS(1)`, `EPS(2)` etc..., if only to use your code as a regular mrgsolve model code and simulate random effects.


### 7.  `$MAIN` block
* Mandatory: 
  + Double every expression containing ETA information, with ETAn (will be used for optimization of parameters) and ETA(n) (generated for simulations with random effects like a "regular" mrgsolve model)
  + Mind the attribution to the good ETAn and ETA(n) as respect to the information you provided in `$PARAM` and `$OMEGA`. This cannot be checked by mapbayr !

```{c, eval = F}
$PK
double CL = TVCL * exp(ETA1 + ETA(1))
```


### 8.  `$CAPTURE` block
* Mandatory: 
  + DV must be captured
  + For models with parent + metabolite, PAR and MET must be captured too.

* Strongly recommended: 
  + Capture a posteriori values of parameters you are interested in (e.g. CL)
  + Do not capture covariates and ETAn (they will be returned by `mapbayest()` anyway)

```{c, eval = F}
$CAPTURE DV PAR MET
```
