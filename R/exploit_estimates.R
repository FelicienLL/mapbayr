#' Compute full PK profile prediction from mapbayr estimates.
#'
#' @param est a list, default output of mbrest
#' @param data dataset to pass to mrgsolve for simulation (default is dataset used for estimation)
#' @param end end of infusion time (passed to mrgsim)
#' @param ... additional argument to pass to mrgsim
#'
#' @return a dataframe, a mrgsolve 'df' output
#' @export
mbrpred <- function(est, data = NULL, end = NULL, ...){
  if(is.null(data)){
    data <- est$data
  }
  if(is.null(end)){
    end <- max(data$time)+24
  }

  ipred <- est$model %>%
    param(est$final_eta) %>%
    zero_re() %>%
    data_set(data) %>%
    obsaug() %>%
    mrgsim_df(carry_out = "evid", end = end, ...) %>%
    as_tibble() %>%
    filter(.data$evid %in% c(0,2)) %>%
    mutate(type = "IPRED")

  pred <- est$model %>%
    zero_re() %>%
    data_set(data) %>%
    obsaug() %>%
    mrgsim_df(carry_out = "evid", end = end, ...) %>%
    as_tibble() %>%
    filter(.data$evid %in% c(0,2)) %>%
    mutate(type = "PRED") %>%
    bind_rows(ipred)

  if(length(obs_cmt(est$model))>1){
    pred <- select(pred, c("ID", "time", "type", "PAR", "MET"))
  } else{
    pred <- select(pred, c("ID", "time", "type", "DV"))
  }

  pred <- pred %>%
    pivot_longer(any_of(c("DV", "PAR", "MET"))) %>%
    mutate(cmt = ifelse(.data$name %in% c("DV", "PAR"), obs_cmt(est$model)[1], obs_cmt(est$model)[2]))%>%
    arrange(.data$ID, .data$time, .data$cmt, .data$type)

  est <- c(est, mapbay_pred = list(pred))
  return(est)
}

#' Plot predictions from mapbayr estimates
#'
#' @param est a list, default output of mbrest augmented with mbrpred
#'
#' @return a ggplot-object
#' @export
mbrplot <- function(est){

  theme_custom <- function(...) {
    theme_light(...) %+replace%
      theme(legend.position = "none")
  }
  scaling <- mbr_conc_scaling(est$model)

  observations <- est$mapbay_tab %>%
    filter(.data$evid==0)

  est$mapbay_pred %>%
    ggplot(aes(.data$time, .data$value)) +
    geom_line(aes(col = .data$type, linetype = .data$type)) +
    geom_point(data = observations, aes(y = .data$DV, fill = as.factor(.data$mdv)), col = "black", size = 3, pch = 21)+
    facet_wrap("cmt", scales = "free", labeller = label_both)+
    theme_custom()+
    scale_fill_manual(values= c("deepskyblue1","black") %>% set_names(c(0,1)))+
    scale_color_manual(values= c("deepskyblue1","black") %>% set_names(c("PRED", "IPRED")))

}

#' Plot posterior distribution of bayesian estimates
#'
#' @param est a list, default output of mbrest
#'
#' @return a ggplot-object
#' @export
mbrdist <- function(est){
  om <- diag(omat(est$model, make = T))
  eta <- unname(est$final_eta)
  name <- mbr_param_names(est$model)

  l <- pmap(list(om = om, eta = eta, name = name), function(om, eta, name){
    tibble(x = c(-3, 3)) %>%
      ggplot(aes(.data$x))+
      stat_function(fun = function(x){dnorm(x, 0, sqrt(om))}, geom = "density", fill = "skyblue", alpha = .3)+
      geom_vline(xintercept = eta, linetype = 2)+
      labs(x = name, y = NULL)+
      theme_bw()
  })

  ggarrange(plotlist = l)
}
