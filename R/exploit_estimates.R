#' Compute full PK profile prediction from mapbayr estimates.
#'
#' @param est a list, default output of mbrest
#' @param data dataset to pass to mrgsolve for simulation (default is dataset used for estimation)
#' @param end end of infusion time (passed to mrgsim)
#' @param ... additional argument to pass to mrgsim
#'
#' @return a dataframe, a mrgsolve 'df' output
#' @export
mbraugment <- function(est, data = NULL, end = NULL, ...){
  if(!inherits(est, "mbrests")) stop("Provided object is not a mbrests class object")

  if(is.null(data)){
    data <- est$data
  }
  if(is.null(end)){
    end <- data %>%
      group_by(.data$ID) %>%
      slice_max(.data$time, with_ties = F) %>%
      pull(.data$time)
    end <- end+24
  }

  carry <- data %>%
    select(-any_of(c("ID", "time", "cmt","DV"))) %>%
    names()

  idata <- preprocess.data(data)

  ipred <- list(data = idata,
                end = end,
                eta = est$final_eta) %>%
    pmap_dfr(function(data, end, eta, ...){
      est$model %>%
        param(eta) %>%
        zero_re() %>%
        data_set(data) %>%
        obsaug() %>%
        mrgsim_df(carry_out = carry, end = end, ...) %>%
        as_tibble() %>%
        filter(.data$evid %in% c(0,2)) %>%
        select(-any_of(est$model@cmtL)) %>%
        mutate(type = "IPRED")
    }, ... = ...)

  pred <- list(data = idata,
               end = end) %>%
    pmap_dfr(function(data, end, eta, ...){
      est$model %>%
        zero_re() %>%
        data_set(data) %>%
        obsaug() %>%
        mrgsim_df(carry_out = carry, end = end, ...) %>%
        as_tibble() %>%
        filter(.data$evid %in% c(0,2)) %>%
        select(-any_of(est$model@cmtL)) %>%
        mutate(type = "PRED")
    }, ... = ...)

  aug_tab <- bind_rows(ipred, pred)

  if(length(obs_cmt(est$model))>1){
    aug_tab <- select(aug_tab, -any_of(c("DV")))
  } else{
    aug_tab <- select(aug_tab, -any_of(c("PAR", "MET")))
  }

  aug_tab <- aug_tab %>%
    pivot_longer(any_of(c("DV", "PAR", "MET"))) %>%
    mutate(cmt = ifelse(.data$name %in% c("DV", "PAR"), obs_cmt(est$model)[1], obs_cmt(est$model)[2]))%>%
    arrange(.data$ID, .data$time, .data$cmt, .data$type)

  est <- c(est, aug_tab = list(aug_tab))
  class(est) <- "mbrests"
  return(est)
}

#' Plot predictions from mapbayr estimates
#'
#' @param est a list, default output of mbrest augmented with mbrpred
#'
#' @return a ggplot-object
#' @export
mbrplot <- function(est){
  if(!inherits(est, "mbrests")) stop("Provided object is not a mbrests class object")

  if(is.null(est$aug_tab)){
    message("$aug_tab provided by mbrplot. Consider mbraugment() to save computational time and options.")
    est <- mbraugment(est)
  }

  theme_custom <- function(...) {
    theme_bw(...) %+replace%
      theme(legend.position = "bottom",
            strip.background = element_rect(fill="white")
      )
  }

  predictions <- est$aug_tab %>%
    mutate(PREDICTION  = .data$type)

  gg <- predictions %>%
    ggplot(aes(.data$time, .data$value)) +
    geom_line(aes(col = .data$PREDICTION, linetype = .data$PREDICTION)) +
    theme_custom()+
    scale_color_manual(values= c(PRED = "deepskyblue1", IPRED = "black"))

  observations <- est$mapbay_tab %>%
    filter(.data$evid==0) %>%
    mutate(MDV = as.factor(.data$mdv))

  #MDV
  if(any(observations$mdv == 1)){
    gg <- gg+
      geom_point(data = observations, aes(y = .data$DV, shape = .data$MDV), fill = "black", size = 3)+
      scale_shape_manual(values= c(`0` = 21, `1` = 1))
  } else {
    gg <- gg+
      geom_point(data = observations, aes(y = .data$DV), fill = "black", size = 3, pch = 21)
  }

  #Facetting

  one_cmt <- length(obs_cmt(est$model)) == 1
  one_ID <- length(est$arg.ofv) == 1

  if(all(!one_cmt, !one_ID)) {
    gg <- gg+
      facet_grid(rows = vars(.data$ID), cols = vars(.data$cmt), scales = "free", labeller = label_both)
  }

  if(all(one_cmt, !one_ID)) {
    gg <- gg+
      facet_grid(rows = vars(.data$ID), scales = "free", labeller = label_both)
  }

  if(all(!one_cmt, one_ID)) {
    gg <- gg+
      facet_grid(cols = vars(.data$cmt), scales = "free", labeller = label_both)
  }

  return(gg)

}

#' Plot posterior distribution of bayesian estimates
#'
#' @param est a list, default output of mbrest
#'
#' @return a ggplot-object
#' @export
mbrdist <- function(est){
  if(!inherits(est, "mbrests")) stop("Provided object is not a mbrests class object")

  om <- odiag(est$model)
  eta <- est$final_eta %>%
    bind_rows() %>%
    as.list() %>%
    unname()
  name <- eta_names(est$model)

  l <- pmap(list(om = om, eta = eta, name = name), function(om, eta, name){
    tibble(x = c(-3, 3)) %>%
      ggplot(aes(.data$x))+
      stat_function(fun = function(x){dnorm(x, 0, sqrt(om))}, geom = "density", fill = "skyblue", alpha = .3)+
      geom_vline(xintercept = eta, linetype = 2)+
      labs(x = name, y = NULL)+
      theme_bw()
  })

  ggarrange(plotlist = l)
}
