#' Compute full PK profile prediction from mapbayr estimates.
#'
#' @param est a list, default output of mbrest
#' @param end end of infusion time (passed to mrgsim)
#' @param ... additional argument to pass to mrgsim
#'
#' @return a dataframe, a mrgsolve 'df' output
#' @export
mbrpred <- function(est, end = NULL, ...){

  if(is.null(end)){
    end <- max(est$data$time)+24
  }
  pred <- est$model %>%
    param(est$final_eta) %>%
    zero_re() %>%
    data_set(est$data) %>%
    obsaug() %>%
    mrgsim_df(carry_out = "evid", end = end, ...) %>%
    as_tibble() %>%
    filter(.data$evid %in% c(0,2))

  if(length(obs_cmt(est$model))>1){
    pred <- select(pred, c("ID", "time", "PAR", "MET"))
  } else{
    pred <- select(pred, c("ID", "time", "DV"))
  }

  pred <- pred %>%
    pivot_longer(any_of(c("DV", "PAR", "MET"))) %>%
    mutate(cmt = ifelse(.data$name %in% c("DV", "PAR"), obs_cmt(est$model)[1], obs_cmt(est$model)[2]))

  est <- c(est, mapbay_pred = list(pred))
  return(est)
}

#' Plot predictions from mapbayr estimates
#'
#' @param est a list, default output of mbrest augmented with compute_pred
#'
#' @return a ggplot-object
#' @export
mbrplot <- function(est){

  theme_custom <- function(...) {
    theme_light(...) %+replace%
      theme(legend.position = "none")
  }
  scaling <- mbr_conc_scaling(est$model)

  observations <- est$mapbay_tab %>%
    filter(.data$evid==0)

  est$mapbay_pred %>%
    ggplot(aes(.data$time, .data$value)) +
    geom_line(col = "black") +
    geom_point(data = observations, aes(y = .data$DV, col = as.factor(.data$mdv)), size = 3)+
    facet_wrap("cmt", scales = "free", labeller = label_both)+
    theme_custom()+
    scale_color_manual(values= c("deepskyblue1","black") %>% set_names(c(0,1)))

}

