---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
```


```{r,echo=FALSE}
library(knitr)
```
# mapbayr <img align="right" src = "inst/logo2.png" width="135px">

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/mapbayr)](https://CRAN.R-project.org/package=mapbayr)
<!-- badges: end -->

mapbayr is a free and open source package for *maximum a posteriori* bayesian estimation in R. Thanks to a single function, `mbrest()`, you can estimate individual PK parameters from: 

* a population PK model coded in *mrgsolve*,
* a data set of concentrations to fit (NM-TRAN format).

It was designed to be easily wrapped in [shiny apps](https://shiny.rstudio.com/) in order to ease model-based therapeutic drug monitoring, also referred to as Model-Informed Prediction Dosing (MIPD).

## Installation 

mapbayr is not (yet) available on CRAN. You can install it from github by executing the following code in R console.

```{r, eval = F}
install.packages("devtools")
devtools::install_github("FelicienLL/mapbayr")
```

mapbayr relies on [mrgsolve](https://github.com/metrumresearchgroup/mrgsolve) for model implementation and ordinary differential equation solving which requires C++ compilers. If you are a Windows user, you would probably need to install Rtools. Please refer to the [installation guide](https://github.com/metrumresearchgroup/mrgsolve/wiki/mrgsolve-Installation) of mrgsolve for additional information.

## Example
```{r,echo = T, results='hide', message=FALSE}
library(mapbayr)
library(mrgsolve)
```

#### 1) Properly code you model 

```{r, echo = T, results='hide', message=FALSE}
code <- "
$PROB
- drug: Examplinib
- model_ref: XXX, J Pharmacokinet, 2020

$PARAM @annotated
TVCL:  0.5 : Clearance
TVV1: 20.0 : Central volume
V2  : 10.0 : Peripheral volume of distribution
Q   :  3.0 : Intercompartmental clearance

ETA1: 0 : Clearance (L/h)
ETA2: 0 : Central volume (L)

$OMEGA 0.3 0.2
$SIGMA
0.06 // proportional
0.1 // additive

$CMT @annotated
CENT  : Central compartment (mg/L)[ADM, OBS]
PERIPH: Peripheral compartment ()

$TABLE
double DV = (CENT/V2) *(1 + EPS(1)) + EPS(2);

$MAIN
double CL = TVCL * exp(ETA1 + ETA(1)) ;
double V1 = TVV1 * exp(ETA2 + ETA(2)) ;
double K12 = Q / V1  ;
double K21 = Q / V2  ;
double K10 = CL / V1 ;

$ODE
dxdt_CENT   =  K21 * PERIPH - (K10 + K12) * CENT ;
dxdt_PERIPH =  K12 * CENT - K21 * PERIPH ;

$CAPTURE DV
"


my_model <- mcode("Example_model", code)
```

#### 2) Build your dataset

```{r, echo = T, results='hide', message=FALSE}
my_data <- data.frame(
  ID = 1, 
  time = c(0, 6, 20, 24),
  amt = c(100, NA, NA, NA), 
  rate = c(20, 0, 0, 0), 
  DV = c(NA, 5, 2, 4), 
  cmt = 1, 
  evid = c(1, 0, 0, 0), 
  mdv = c(1, 0, 0, 1)
)
```

#### 3) And estimate !

```{r, message=FALSE}
est <- mbrest(my_model, data = my_data)
```
As building dataset into a NM-tran format can be painful, you can use pipe-friendly functions in order to pass administration and observation information, and perform the estimation subsequently.
```{r, eval=FALSE}
est <- my_model %>% 
  adm_lines(time = 0, amt = 100, rate = 20) %>% 
  obs_lines(time = 6, DV = 5) %>% 
  obs_lines(time = 20, DV = 2) %>% 
  obs_lines(time = 24, DV = 4, mdv = 1) %>% 
  mbrest()
```

#### 4) Then, use the estimations
The results are returned in a single object ("mbrests" S3 class) which includes input (model and data), output (etas and tables) and internal arguments passed to the internal algorithm (useful for debugging). Additional methods are provided, notably to plot the results quickly. 

```{r, message=FALSE}
print(est)
```

```{r, plot1, fig.height=4, message=FALSE}
mbrplot(est)
```

```{r, plot2, fig.height=2.5, message=FALSE}
mbrdist(est)  
```

## Development

mapbayr is under development. Your feedback for additional features request or bug reporting is welcome. Contact us through the [issue tracker](https://github.com/FelicienLL/mapbayr/issues).

## Features

mapbayr is a generalization of the "MAP Bayes estimation" tutorial available on the [mrgsolve blog](https://mrgsolve.github.io/blog/map_bayes.html). Additional features are: 

* a unique function to perform the estimation: `mbrest()`.
* handles multiple error models such as additive, proportional, mixed or exponential error (without prior log-transformation of data).
* fit multiple patients stored in a single dataset. 
* fit both parent drug and metabolite simultaneously.
* accepts any kind of models thanks to the flexibility of mrgsolve. 
* functions to easily pass administration and observation information, as well as plot methods to visualize predictions and parameter distribution.
* a single output object to ease post-processing, depending on the purpose of the estimation.
* several optimization algorithm available, such as "L-BFGS-B" (the default) or "NEWUOA".

## Performance

Performance, in terms of quality of parameter predictions, was validated against NONMEM for a wide variety of models and data. However predictions might differ depending on the complexity of the user's data or model, or as function of the number of parameter to estimate. The user is invited to investigate if discrepancies come from the prediction of the concentrations (i.e. mrgsolve) or from the optimization process *per se* (i.e. mapbayr). Feel free to contact us through the [issue tracker](https://github.com/FelicienLL/mapbayr/issues).

## *mrgsolve* model specification

mapbayr contains a library of example model files (.cpp), accessible with `mbrlib()`
```{r, eval = F}
my_model <- mread("ex_mbr1.cpp", mbrlib())
```

The user is invited to perform map-bayesian estimation with his/her own mrgsolve models. These model files should be slightly modified in order to be "read" by mapbayr with the subsequent specifications : 

### 1.  `$PARAM` block
#### ETA specifications
* Mandatory: 
  + Add as many ETA as there are parameters to estimate (i.e. the length of the OMEGA matrix diagonal). 
  + Refer them as ETAn (n being the number of ETA).
  + Set 0 as default value. 
* Strongly recommended:   
  + Provide a description as a plain text (will be used as internal “eta names”)
```{c, eval = F}
$PARAM @annotated
ETA1 : 0 : CL (L/h)
ETA2 : 0 : VC (L)
ETA3 : 0 : F ()
//do not write ETA(1)
//do not write iETA

```

#### Covariates
* Strongly recommended : 
  + Use a `@covariates` tag to record covariates in the `$PARAM` block. 
  + Set the reference value. 
  + Provide a description as a plain text (will be used as internal “covariate names”) 
  + Provide units in parentheses (description of 0/1 coding is advised for categorical covariates)

```{c, eval = F}
$PARAM @annotated @covariates
BW : 70 : Body weight (kg)
SEX : 0 : Sex (0=Male, 1=Female)
//do not write
//$PARAM @annotated
//BW : 70 : Body weight (kg)
```
 
When time or dose are needed as covariates, an internal routine is embedded in mapbayr. You can refer them as TOLA and AOLA (i.e. time of last administration, amount of last administration).

 
```{c, eval = F}
$PARAM @annotated @covariates
TOLA : 0 : Time of last adm (h)
AOLA : 100 : Amt of last adm (mg)
```


### 2.  `$CMT` block
* Mandatory: 
  + A `@annotated` tag must be used to record compartments.
  + Write OBS in brackets to define the observation compartment(s). This information is **mandatory** for the optimization process. Also used by `obs_lines()` to build your dataset. 
Strongly recommended: 
  + Write ADM in brackets to define "default" administration compartment(s). This information is not used for optimization process and the `mbrest()` function. The information is mandatory if you use `adm_lines()` to build your dataset in order to automatically set the value of the 'cmt' column. Especially useful if you use a model with an absorption from several depot compartment requiring to duplicate administrations lines in the data set. 

```{c, eval = F}
//example: model with dual zero and first order absorption in compartment 1 & 2, respectively, and observation of parent drug + metabolite 
$CMT @annotated
DEPOT: Depot [ADM]
CENT_PAR: examplinib central [ADM, OBS]
PERIPH : examplinib peripheral
CENT_MET : methylexamplinib central [OBS] 
```

### 3.  `$OMEGA` block
* Mandatory: 
  + The length of the omega matrix must be the same as the number of ETAn provided in `$PARAM`.
  + The order of the omega values must correspond to the order of the ETAs provided in `$PARAM`. This cannot be checked by mapbayr !
* Optional: 
  + Omega values can be recorded in multiple blocks such as in a regular mrgsolve model code.

```{c, eval = F}
$OMEGA
0.123 0.456 0.789
$OMEGA @block
0.111 
0.222 0.333
```

### 4.  `$SIGMA` block
* Mandatory : 
  + A pair of two (diagonal) values is expected per dependent variable. The first value represents proportional error, the second is (log) additive error.
  + The order of the pairs must respect the order of the compartments assigned with [OBS] in `$CMT`. This cannot be checked by mapbayr !

To put it more clearly, the sigma matrix will be interpreted as such whatever the model : 

| N° in the SIGMA matrix diagonal | Associated error |
|:-------------------------------:|:----------------:|
| 1 | Proportional on concentrations in the 1st cmt with [OBS] |
| 2 | Additive on concentrations in the 1st cmt with [OBS] |
| 3 | Proportional on concentrations in the 2nd cmt with [OBS] |
| 4 | Additive on concentrations in the 2nd cmt with [OBS] |
| ... | ... |
  
For a model describing the concentrations of a single compound (i.e. parent drug only), the error model can be coded as such: 
```{c, eval = F}
$SIGMA 0.111 0 // proportional error 
```
```{c, eval = F}
$SIGMA 0 0.222 // (log) additive error
```
```{c, eval = F}
$SIGMA 0.333 0.444 // mixed error
```

For a model describing the concentrations of two variables (i.e. parent drug and metabolite), four values are expected: a pair of proportional and additive error for both compounds. 
```{c, eval = F}
//example: correlated proportional error between parent and metabolite
$SIGMA 
0.050 // proportional error on parent drug
0.000 0.000 // additive error on parent drug
0.100 0.000 0.200 // proportional error on metabolite
0.000 0.000 0.000 0.000 // additive error on metabolite
```
* Optional: 
  + Sigma values can be recorded in multiple blocks such as in a regular mrgsolve model code.

### 6.  `$TABLE` block or `$ERROR` block
* Mandatory: 
  + Refer the concentration variable to fit as `DV`. Mind the code, especially if concentrations are observed in multiple compartments. 
  + Express log-additive error models as exponential. This way, concentrations will automatically log-transformed during the optimization process, with no necessity to prior log-transform your concentration. 
```{c, eval = F}
$TABLE
double DV  = (CENTRAL / VC) * exp(EPS(2)) ;
```
  + For fitting parent drug and metabolite simultaneously, refer to them as PAR and MET, and define DV accordingly (only DV will be used during the optimization process, but PAR and MET variables are mandatory for post-processing internal functions)

```{c, eval = F}
$TABLE
double PAR = (CENT_PAR / V) * (1 + EPS(1)) ;
double MET = (CENT_MET / V) * (1 + EPS(3)) ;
double DV = PAR ;
if(self.cmt == 4) DV = MET ; 
// reminder: use "self.cmt" to internaly refer to a compartment in a mrgsolve model code. 
```


### 7.  `$MAIN` block
* Mandatory: 
  + Double every expression containing ETA information, with ETAn (will be used for optimization of parameters) and ETA(n) (generated for simulations with random effects like a "regular" mrgsolve model)
  + Mind the attribution to the good ETAn and ETA(n) as respect to the information you provided in `$PARAM` and `$OMEGA`. This cannot be checked by mapbayr !

```{c, eval = F}
$PK
double CL = TVCL * exp(ETA1 + ETA(1))
```


### 8.  `$CAPTURE` block
* Mandatory: 
  + DV must be captured
  + For models with parent + metabolite, PAR and MET must be captured too.

```{c, eval = F}
$CAPTURE DV PAR MET
```











































 
 
 
 
 
 
 
 
 
 
 
  

