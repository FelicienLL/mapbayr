---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
```


```{r,echo=FALSE}
library(knitr)
```
# mapbayr <img align="right" src = "inst/logo.png" width="135px">

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version-last-release/mapbayr)](https://CRAN.R-project.org/package=mapbayr)
<!-- badges: end -->

mapbayr is a free and open source package for *maximum a posteriori* bayesian estimation of PK parameters in R. Thanks to a single function, `mapbayest()`, you can estimate individual PK parameters from: 

* a population PK model coded in *mrgsolve*,
* a data set of concentrations to fit (NM-TRAN format).

It was designed to be easily wrapped in [shiny apps](https://github.com/FelicienLL/mapbayr-shiny) in order to ease model-based Therapeutic Drug Monitoring, also referred to as Model-Informed Prediction Dosing (MIPD).

## Installation 

mapbayr is available on [CRAN](https://CRAN.R-project.org/package=mapbayr). You can install the development version from github by executing the following code in R console.

```{r, eval = F}
install.packages("devtools")
devtools::install_github("FelicienLL/mapbayr")
```

mapbayr relies on [mrgsolve](https://github.com/metrumresearchgroup/mrgsolve) for model implementation and ordinary differential equation solving which requires C++ compilers. If you are a Windows user, you would probably need to install [Rtools](https://cran.r-project.org/bin/windows/Rtools/). Please refer to the [installation guide of mrgsolve](https://github.com/metrumresearchgroup/mrgsolve/wiki/mrgsolve-Installation) for additional information.

## Example
```{r,echo = T, results='hide', message=FALSE}
library(mapbayr)
library(mrgsolve)
```

```{r message=FALSE, include=FALSE, results='hide'}
devtools::load_all()
```

#### 1) Properly code you model 

```{r, echo = T, results='hide', message=FALSE}
code <- "
$PARAM @annotated
TVCL:  0.9 : Clearance
TVV1: 10.0 : Central volume
V2  : 10.0 : Peripheral volume of distribution
Q   :  1.0 : Intercompartmental clearance

ETA1: 0 : Clearance (L/h)
ETA2: 0 : Central volume (L)

$PARAM @annotated @covariates
BW : 70 : Body weight (kg)

$OMEGA 0.3 0.3
$SIGMA
0.05 // proportional
0.1 // additive

$CMT @annotated
CENT  : Central compartment (mg/L)[ADM, OBS]
PERIPH: Peripheral compartment ()

$TABLE
double DV = (CENT/V1) *(1 + EPS(1)) + EPS(2);

$MAIN
double CL = TVCL * exp(ETA1 + ETA(1)) * pow(BW / 70, 1.2) ;
double V1 = TVV1 * exp(ETA2 + ETA(2)) ;
double K12 = Q / V1  ;
double K21 = Q / V2  ;
double K10 = CL / V1 ;

$ODE
dxdt_CENT   =  K21 * PERIPH - (K10 + K12) * CENT ;
dxdt_PERIPH =  K12 * CENT - K21 * PERIPH ;

$CAPTURE DV CL
"


my_model <- mcode("Example_model", code)
```

#### 2) Bring your dataset

```{r, echo = T,  message=FALSE}
my_data <- data.frame(ID = 1, time = c(0,6,15,24), evid = c(1, rep(0,3)), cmt = 1, amt = c(100, rep(0,3)), 
                      rate = c(20, rep(0,3)), DV = c(NA, 3.9, 1.1, 2), mdv = c(1,0,0,1), BW = 90)
my_data
```

#### 3) And estimate !

```{r, message=FALSE}
my_est <- mapbayest(my_model, data = my_data)
```
As building dataset into a NM-TRAN format can be painful, you can use pipe-friendly `obs_lines()`, `adm_lines()` and `add_covariates()` functions in order to pass administration and observation information, and perform the estimation subsequently. 
```{r, eval=FALSE}
my_est <- my_model %>% 
  adm_lines(time = 0, amt = 100, rate = 20) %>% 
  obs_lines(time = 6, DV = 3.9) %>% 
  obs_lines(time = 20, DV = 1.1) %>% 
  obs_lines(time = 24, DV = 2, mdv = 1) %>% 
  add_covariates(list(BW = 90)) %>% 
  mapbayest()
```

#### 4) Then, use the estimations
The results are returned in a single object ("mapbayests" S3 class) which includes input (model and data), output (etas and tables) and internal arguments passed to the internal algorithm (useful for debugging). Additional methods are provided to ease visualization and computation of a posteriori outcomes of interest. 

```{r, message=FALSE}
print(my_est)
```

```{r, plot1, fig.height=4, message=FALSE}
plot(my_est)
```

```{r, plot2, fig.height=2.5, message=FALSE}
hist(my_est)  
```

```{r, plot3, message = FALSE}
# Easily extract a posteriori parameter values to compute outcomes of interest
get_eta(my_est)
get_param(my_est, "CL")

# The `use_posterior()` functions updates the model object with posterior values and covariates to simulate like with a regular mrgsolve model
my_est %>% 
  use_posterior() %>% 
  data_set(expand.ev(amt = c(50, 100, 200, 500), dur = c(5, 24)) %>% mutate(rate = amt/dur)) %>% 
  carry_out(dur) %>% 
  mrgsim() %>% 
  plot(DV~time|factor(dur), scales = "same")

```

## Development

mapbayr is under development. Your feedback for additional feature requests or bug reporting is welcome. Contact us through the [issue tracker](https://github.com/FelicienLL/mapbayr/issues).

## Features

mapbayr is a generalization of the "MAP Bayes estimation" tutorial available on the [mrgsolve blog](https://mrgsolve.github.io/blog/map_bayes.html). Additional features are: 

* a unique function to perform the estimation: `mapbayest()`.
* fit multiple patients stored in a single dataset. 
* handles multiple error models such as additive, proportional, mixed or exponential error (without prior log-transformation of data).
* fit both parent drug and metabolite simultaneously.
* accepts any kind of models thanks to the flexibility of mrgsolve. 
* functions to easily pass administration and observation information, as well as plot methods to visualize predictions and parameter distribution.
* a single output object to ease post-processing, depending on the purpose of the estimation.
* several optimization algorithm available, such as "L-BFGS-B" (the default) or "newuoa".

## Performance

Performance, in terms of quality of parameter predictions, was validated against NONMEM for a wide variety of models and data. However predictions might differ depending on the complexity of the user's data or model, or as function of the number of parameter to estimate. The user is invited to investigate if discrepancies come from the prediction of the concentrations (i.e. mrgsolve) or from the optimization process *per se* (i.e. mapbayr). Feel free to contact us through the [issue tracker](https://github.com/FelicienLL/mapbayr/issues).












































 
 
 
 
 
 
 
 
 
 
 
  

